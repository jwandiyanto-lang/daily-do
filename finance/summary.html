<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#FFFFFF">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Finance</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #FFFFFF; min-height: 100vh; color: #1E293B; padding: 16px; padding-bottom: 100px; }

    .header { margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.5rem; font-weight: 800; }
    .header h1 span { color: #10B981; }
    .header-actions { display: flex; gap: 8px; }
    .icon-btn { width: 40px; height: 40px; border-radius: 12px; border: 1px solid #E2E8F0; background: #F8FAFC; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.1rem; }

    /* Summary Cards */
    .summary-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
    .summary-card { background: #F8FAFC; border-radius: 12px; padding: 12px; border: 1px solid #E2E8F0; }
    .summary-label { font-size: 0.6rem; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; font-weight: 600; }
    .summary-value { font-size: 1rem; font-weight: 700; }
    .summary-value.green { color: #10B981; }
    .summary-value.red { color: #EF4444; }
    .summary-value.blue { color: #3B82F6; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
    .tabs::-webkit-scrollbar { display: none; }
    .tab-btn { flex-shrink: 0; padding: 10px 14px; background: #F1F5F9; border: none; border-radius: 10px; color: #64748B; font-size: 0.75rem; font-weight: 600; cursor: pointer; font-family: inherit; }
    .tab-btn.active { background: #10B981; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Search */
    .search-bar { display: flex; gap: 8px; margin-bottom: 12px; }
    .search-input { flex: 1; padding: 12px 16px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; font-size: 0.9rem; font-family: inherit; }
    .search-input:focus { outline: none; border-color: #10B981; }

    /* Filter Pills */
    .filter-row { display: flex; gap: 6px; overflow-x: auto; margin-bottom: 12px; padding-bottom: 4px; }
    .filter-row::-webkit-scrollbar { display: none; }
    .filter-pill { flex-shrink: 0; padding: 6px 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 16px; font-size: 0.75rem; color: #64748B; cursor: pointer; font-family: inherit; }
    .filter-pill.active { background: #10B981; border-color: #10B981; color: #fff; }

    /* Transaction List */
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .section-title { font-size: 0.7rem; font-weight: 700; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; }
    .list { display: flex; flex-direction: column; gap: 6px; }
    .item { background: #F8FAFC; border-radius: 12px; padding: 12px; border: 1px solid #E2E8F0; display: flex; align-items: center; gap: 10px; }
    .item-icon { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .item-details { flex: 1; min-width: 0; }
    .item-title { font-size: 0.85rem; font-weight: 600; color: #1E293B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-meta { font-size: 0.7rem; color: #64748B; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .item-tag { padding: 1px 6px; background: #E0F2FE; color: #0284C7; border-radius: 4px; font-size: 0.65rem; font-weight: 500; }
    .item-amount { font-size: 0.95rem; font-weight: 700; text-align: right; }
    .item-amount.income { color: #10B981; }
    .item-amount.expense { color: #EF4444; }
    .date-header { font-size: 0.65rem; color: #94A3B8; text-transform: uppercase; letter-spacing: 0.5px; margin: 12px 0 6px; font-weight: 600; }

    /* Budget Card */
    .budget-card { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 14px; padding: 14px; margin-bottom: 10px; }
    .budget-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .budget-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .budget-info { flex: 1; }
    .budget-name { font-weight: 600; font-size: 0.9rem; }
    .budget-spent { font-size: 0.75rem; color: #64748B; }
    .budget-amount { text-align: right; }
    .budget-remaining { font-weight: 700; font-size: 0.9rem; }
    .budget-limit { font-size: 0.7rem; color: #64748B; }
    .progress-bar { height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
    .progress-fill.safe { background: #10B981; }
    .progress-fill.warning { background: #F59E0B; }
    .progress-fill.danger { background: #EF4444; }

    /* Fund Card */
    .fund-card { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 14px; padding: 14px; margin-bottom: 10px; }
    .fund-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .fund-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
    .fund-info { flex: 1; }
    .fund-name { font-weight: 700; font-size: 0.95rem; }
    .fund-meta { font-size: 0.75rem; color: #64748B; }
    .fund-progress { margin-bottom: 10px; }
    .progress-stats { display: flex; justify-content: space-between; font-size: 0.75rem; color: #64748B; margin-top: 6px; }
    .progress-current { font-weight: 700; color: #10B981; }
    .fund-actions { display: flex; gap: 6px; }
    .fund-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; font-family: inherit; }
    .fund-btn.add { background: #10B981; color: #fff; }
    .fund-btn.withdraw { background: #E2E8F0; color: #64748B; }

    /* Insights */
    .insight-card { background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%); border: 1px solid #86EFAC; border-radius: 14px; padding: 14px; margin-bottom: 10px; }
    .insight-card.warning { background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%); border-color: #FCD34D; }
    .insight-card.info { background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%); border-color: #93C5FD; }
    .insight-icon { font-size: 1.5rem; margin-bottom: 8px; }
    .insight-title { font-weight: 700; font-size: 0.9rem; color: #065F46; margin-bottom: 4px; }
    .insight-card.warning .insight-title { color: #92400E; }
    .insight-card.info .insight-title { color: #1E40AF; }
    .insight-text { font-size: 0.8rem; color: #047857; line-height: 1.4; }
    .insight-card.warning .insight-text { color: #A16207; }
    .insight-card.info .insight-text { color: #1D4ED8; }

    /* Chart */
    .chart-container { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 14px; padding: 14px; margin-bottom: 16px; }
    .chart-title { font-size: 0.8rem; font-weight: 700; color: #64748B; margin-bottom: 12px; }
    .chart { display: flex; align-items: flex-end; gap: 8px; height: 120px; }
    .chart-bar { flex: 1; background: #10B981; border-radius: 4px 4px 0 0; min-height: 4px; position: relative; }
    .chart-bar.expense { background: #EF4444; }
    .chart-label { position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: #64748B; white-space: nowrap; }
    .chart-legend { display: flex; gap: 16px; justify-content: center; margin-top: 24px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #64748B; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* Net Worth */
    .networth-card { background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 20px; margin-bottom: 16px; color: #fff; }
    .networth-label { font-size: 0.8rem; color: #94A3B8; margin-bottom: 4px; }
    .networth-amount { font-size: 2rem; font-weight: 800; margin-bottom: 12px; }
    .networth-breakdown { display: flex; gap: 16px; }
    .networth-item { flex: 1; }
    .networth-item-label { font-size: 0.7rem; color: #94A3B8; }
    .networth-item-value { font-size: 1rem; font-weight: 700; }
    .networth-item-value.green { color: #10B981; }
    .networth-item-value.red { color: #F87171; }

    /* Calculator */
    .calc-card { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 14px; padding: 16px; margin-bottom: 12px; }
    .calc-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .calc-desc { font-size: 0.8rem; color: #64748B; margin-bottom: 12px; }
    .calc-inputs { display: flex; flex-direction: column; gap: 10px; }
    .calc-row { display: flex; gap: 10px; }
    .calc-field { flex: 1; }
    .calc-label { font-size: 0.7rem; color: #64748B; margin-bottom: 4px; font-weight: 600; }
    .calc-input { width: 100%; padding: 10px 12px; background: #fff; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 0.9rem; font-family: inherit; }
    .calc-input:focus { outline: none; border-color: #10B981; }
    .calc-result { margin-top: 12px; padding: 12px; background: #F0FDF4; border-radius: 10px; text-align: center; }
    .calc-result-label { font-size: 0.75rem; color: #047857; margin-bottom: 2px; }
    .calc-result-value { font-size: 1.3rem; font-weight: 800; color: #10B981; }

    /* AI Chat */
    .chat-container { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 14px; display: flex; flex-direction: column; height: calc(100vh - 240px); min-height: 350px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 10px; }
    .message { max-width: 85%; padding: 12px 14px; border-radius: 14px; font-size: 0.85rem; line-height: 1.4; }
    .ai-message { background: #fff; align-self: flex-start; border: 1px solid #E2E8F0; color: #1E293B; }
    .user-message { background: #10B981; color: #fff; align-self: flex-end; }
    .chat-input-area { padding: 10px; border-top: 1px solid #E2E8F0; display: flex; gap: 8px; }
    .chat-input { flex: 1; padding: 12px 14px; background: #fff; border: 1px solid #E2E8F0; border-radius: 20px; font-size: 0.85rem; font-family: inherit; }
    .chat-input:focus { outline: none; border-color: #10B981; }
    .chat-send { width: 44px; height: 44px; border-radius: 50%; background: #10B981; border: none; color: #fff; cursor: pointer; font-size: 1.1rem; }
    .quick-prompts { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
    .quick-prompt { padding: 6px 10px; background: #E0F2FE; border: none; border-radius: 12px; font-size: 0.7rem; color: #0284C7; cursor: pointer; font-family: inherit; }

    /* Empty State */
    .empty-state { text-align: center; padding: 30px 20px; }
    .empty-icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }
    .empty-state p { color: #64748B; font-size: 0.85rem; }

    /* Add Button */
    .add-btn { width: 100%; padding: 14px; background: #F0FDF4; border: 2px dashed #86EFAC; border-radius: 12px; color: #10B981; font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 10px; }

    /* FAB */
    .fab { position: fixed; bottom: 85px; right: 16px; width: 54px; height: 54px; border-radius: 50%; background: #10B981; color: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); z-index: 100; font-size: 1.6rem; }

    /* Modal */
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; z-index: 200; }
    .modal.hidden { display: none; }
    .modal-content { width: 100%; max-width: 500px; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-title { font-size: 1.1rem; font-weight: 800; }
    .modal-close { background: none; border: none; color: #94A3B8; font-size: 1.3rem; cursor: pointer; }
    .form-group { margin-bottom: 14px; }
    .form-label { display: block; font-size: 0.7rem; color: #64748B; margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
    .form-input { width: 100%; padding: 12px 14px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 10px; font-size: 0.95rem; font-family: inherit; }
    .form-input:focus { outline: none; border-color: #10B981; }
    .type-toggle { display: flex; gap: 8px; margin-bottom: 14px; }
    .type-btn { flex: 1; padding: 12px; border: 2px solid #E2E8F0; border-radius: 10px; background: transparent; color: #64748B; font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: inherit; }
    .type-btn.expense.active { border-color: #EF4444; background: #FEF2F2; color: #EF4444; }
    .type-btn.income.active { border-color: #10B981; background: #F0FDF4; color: #10B981; }
    .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .category-btn { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 10px 6px; background: #F8FAFC; border: 2px solid transparent; border-radius: 10px; cursor: pointer; }
    .category-btn.active { border-color: #10B981; background: #F0FDF4; }
    .category-btn .emoji { font-size: 1.2rem; }
    .category-btn .label { font-size: 0.6rem; color: #64748B; }
    .submit-btn { width: 100%; padding: 14px; background: #10B981; border: none; border-radius: 12px; color: #fff; font-size: 0.95rem; font-weight: 700; cursor: pointer; font-family: inherit; margin-top: 14px; }
    .tags-input { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 10px; min-height: 44px; }
    .tag { display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: #E0F2FE; color: #0284C7; border-radius: 6px; font-size: 0.75rem; }
    .tag-remove { cursor: pointer; font-size: 0.9rem; }
    .tag-input { border: none; background: none; outline: none; flex: 1; min-width: 60px; font-size: 0.85rem; font-family: inherit; }

    /* Recurring Badge */
    .recurring-badge { display: inline-flex; align-items: center; gap: 2px; padding: 2px 6px; background: #F3E8FF; color: #7C3AED; border-radius: 4px; font-size: 0.6rem; font-weight: 600; }

    /* Bottom Nav */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #E2E8F0; padding: 8px 0 20px; z-index: 50; }
    .nav-items { display: flex; justify-content: space-around; list-style: none; max-width: 500px; margin: 0 auto; }
    .nav-link { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #94A3B8; padding: 6px 16px; border-radius: 10px; }
    .nav-link.active { color: #10B981; background: rgba(16, 185, 129, 0.1); }
    .nav-icon { font-size: 1.2rem; margin-bottom: 2px; }
    .nav-label { font-size: 0.65rem; font-weight: 600; }

    /* API Setup */
    .api-setup { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 14px; padding: 16px; margin-bottom: 12px; }
    .api-setup-title { font-size: 0.85rem; font-weight: 700; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üí∞ <span>Finance</span></h1>
    <div class="header-actions">
      <button class="icon-btn" onclick="openImportModal()">üì•</button>
      <button class="icon-btn" onclick="exportData()">üì§</button>
    </div>
  </div>

  <div class="summary-row">
    <div class="summary-card">
      <div class="summary-label">Income</div>
      <div class="summary-value green" id="totalIncome">$0</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Expenses</div>
      <div class="summary-value red" id="totalExpense">$0</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Balance</div>
      <div class="summary-value blue" id="totalBalance">$0</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('transactions')">Transactions</button>
    <button class="tab-btn" onclick="switchTab('budgets')">Budgets</button>
    <button class="tab-btn" onclick="switchTab('funds')">Funds</button>
    <button class="tab-btn" onclick="switchTab('insights')">Insights</button>
    <button class="tab-btn" onclick="switchTab('tools')">Tools</button>
    <button class="tab-btn" onclick="switchTab('advisor')">AI</button>
  </div>

  <!-- TRANSACTIONS TAB -->
  <div id="transactions-tab" class="tab-content active">
    <div class="search-bar">
      <input type="text" class="search-input" id="searchInput" placeholder="Search transactions..." oninput="filterTransactions()">
    </div>
    <div class="filter-row" id="categoryFilter"></div>
    <div class="section-header">
      <span class="section-title">Transactions</span>
      <span class="section-title" id="transactionCount">0</span>
    </div>
    <div class="list" id="transactionList"></div>
  </div>

  <!-- BUDGETS TAB -->
  <div id="budgets-tab" class="tab-content">
    <div class="section-header">
      <span class="section-title">Monthly Budgets</span>
      <span class="section-title" id="budgetMonth"></span>
    </div>
    <div id="budgetList"></div>
    <button class="add-btn" onclick="openBudgetModal()">+ Add Budget</button>
  </div>

  <!-- FUNDS TAB -->
  <div id="funds-tab" class="tab-content">
    <div class="section-header">
      <span class="section-title">Savings Goals</span>
      <span class="section-title" id="fundsTotal">$0</span>
    </div>
    <div id="fundsList"></div>
    <button class="add-btn" onclick="openFundModal()">+ Create Fund</button>
  </div>

  <!-- INSIGHTS TAB -->
  <div id="insights-tab" class="tab-content">
    <div class="networth-card">
      <div class="networth-label">Net Worth</div>
      <div class="networth-amount" id="netWorth">$0</div>
      <div class="networth-breakdown">
        <div class="networth-item">
          <div class="networth-item-label">Assets</div>
          <div class="networth-item-value green" id="totalAssets">$0</div>
        </div>
        <div class="networth-item">
          <div class="networth-item-label">Liabilities</div>
          <div class="networth-item-value red" id="totalLiabilities">$0</div>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Last 6 Months</div>
      <div class="chart" id="monthlyChart"></div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:#10B981"></div> Income</div>
        <div class="legend-item"><div class="legend-dot" style="background:#EF4444"></div> Expenses</div>
      </div>
    </div>

    <div class="section-title" style="margin-bottom:10px;">AI Insights</div>
    <div id="insightsList"></div>
  </div>

  <!-- TOOLS TAB -->
  <div id="tools-tab" class="tab-content">
    <div class="calc-card">
      <div class="calc-title">üè¶ Compound Interest</div>
      <div class="calc-desc">See how your money grows over time</div>
      <div class="calc-inputs">
        <div class="calc-row">
          <div class="calc-field">
            <div class="calc-label">Principal ($)</div>
            <input type="number" class="calc-input" id="ciPrincipal" value="1000" oninput="calcCompound()">
          </div>
          <div class="calc-field">
            <div class="calc-label">Monthly Add ($)</div>
            <input type="number" class="calc-input" id="ciMonthly" value="100" oninput="calcCompound()">
          </div>
        </div>
        <div class="calc-row">
          <div class="calc-field">
            <div class="calc-label">Rate (%/year)</div>
            <input type="number" class="calc-input" id="ciRate" value="7" oninput="calcCompound()">
          </div>
          <div class="calc-field">
            <div class="calc-label">Years</div>
            <input type="number" class="calc-input" id="ciYears" value="10" oninput="calcCompound()">
          </div>
        </div>
      </div>
      <div class="calc-result">
        <div class="calc-result-label">Future Value</div>
        <div class="calc-result-value" id="ciResult">$0</div>
      </div>
    </div>

    <div class="calc-card">
      <div class="calc-title">üéØ Financial Freedom</div>
      <div class="calc-desc">When can you retire?</div>
      <div class="calc-inputs">
        <div class="calc-row">
          <div class="calc-field">
            <div class="calc-label">Monthly Expenses</div>
            <input type="number" class="calc-input" id="ffExpenses" value="3000" oninput="calcFreedom()">
          </div>
          <div class="calc-field">
            <div class="calc-label">Current Savings</div>
            <input type="number" class="calc-input" id="ffSavings" value="10000" oninput="calcFreedom()">
          </div>
        </div>
        <div class="calc-row">
          <div class="calc-field">
            <div class="calc-label">Monthly Saving</div>
            <input type="number" class="calc-input" id="ffMonthlySave" value="500" oninput="calcFreedom()">
          </div>
          <div class="calc-field">
            <div class="calc-label">Return Rate (%)</div>
            <input type="number" class="calc-input" id="ffReturn" value="7" oninput="calcFreedom()">
          </div>
        </div>
      </div>
      <div class="calc-result">
        <div class="calc-result-label">Years to Freedom (4% rule)</div>
        <div class="calc-result-value" id="ffResult">0 years</div>
      </div>
    </div>

    <div class="calc-card">
      <div class="calc-title">üìä ROI Calculator</div>
      <div class="calc-desc">Calculate return on investment</div>
      <div class="calc-inputs">
        <div class="calc-row">
          <div class="calc-field">
            <div class="calc-label">Initial Investment</div>
            <input type="number" class="calc-input" id="roiInitial" value="1000" oninput="calcROI()">
          </div>
          <div class="calc-field">
            <div class="calc-label">Final Value</div>
            <input type="number" class="calc-input" id="roiFinal" value="1500" oninput="calcROI()">
          </div>
        </div>
      </div>
      <div class="calc-result">
        <div class="calc-result-label">Return on Investment</div>
        <div class="calc-result-value" id="roiResult">50%</div>
      </div>
    </div>
  </div>

  <!-- AI ADVISOR TAB -->
  <div id="advisor-tab" class="tab-content">
    <div id="api-notice" class="api-setup" style="display:none;">
      <div class="api-setup-title">üîë API Key Required</div>
      <p style="font-size:0.8rem;color:#64748B;margin-bottom:10px;">Add your Anthropic API key to use AI.</p>
      <input type="password" class="form-input" id="api-key-input" placeholder="sk-ant-api...">
      <button class="submit-btn" onclick="saveApiKey()" style="margin-top:10px;">Save Key</button>
    </div>
    <div class="quick-prompts">
      <button class="quick-prompt" onclick="askAI('How am I doing financially?')">How am I doing?</button>
      <button class="quick-prompt" onclick="askAI('Where can I cut expenses?')">Cut expenses</button>
      <button class="quick-prompt" onclick="askAI('Help me create a savings plan')">Savings plan</button>
      <button class="quick-prompt" onclick="askAI('Analyze my spending patterns')">Spending patterns</button>
    </div>
    <div class="chat-container" id="chat-container">
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chat-input" placeholder="Ask anything...">
        <button class="chat-send" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <button class="fab" id="fab" onclick="openTransactionModal()">+</button>

  <!-- TRANSACTION MODAL -->
  <div id="transactionModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Add Transaction</span>
        <button class="modal-close" onclick="closeModal('transactionModal')">√ó</button>
      </div>
      <div class="type-toggle">
        <button class="type-btn expense active" onclick="setType('expense')">Expense</button>
        <button class="type-btn income" onclick="setType('income')">Income</button>
      </div>
      <div class="form-group">
        <label class="form-label">Amount</label>
        <input type="number" id="txAmount" class="form-input" placeholder="0.00" inputmode="decimal">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" id="txDesc" class="form-input" placeholder="What was this for?">
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <div class="category-grid" id="categoryGrid"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Tags (optional)</label>
        <div class="tags-input" id="tagsInput" onclick="document.getElementById('tagInput').focus()">
          <input type="text" class="tag-input" id="tagInput" placeholder="Add tag..." onkeydown="handleTagInput(event)">
        </div>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;font-size:0.85rem;">
          <input type="checkbox" id="txRecurring"> Recurring monthly
        </label>
      </div>
      <button class="submit-btn" onclick="addTransaction()">Add Transaction</button>
    </div>
  </div>

  <!-- BUDGET MODAL -->
  <div id="budgetModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Add Budget</span>
        <button class="modal-close" onclick="closeModal('budgetModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select id="budgetCategory" class="form-input"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Monthly Limit</label>
        <input type="number" id="budgetLimit" class="form-input" placeholder="500" inputmode="decimal">
      </div>
      <button class="submit-btn" onclick="addBudget()">Add Budget</button>
    </div>
  </div>

  <!-- FUND MODAL -->
  <div id="fundModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Create Fund</span>
        <button class="modal-close" onclick="closeModal('fundModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" id="fundName" class="form-input" placeholder="Emergency Fund">
      </div>
      <div class="form-group">
        <label class="form-label">Target Amount</label>
        <input type="number" id="fundTarget" class="form-input" placeholder="10000" inputmode="decimal">
      </div>
      <div class="form-group">
        <label class="form-label">Icon</label>
        <div class="category-grid" id="fundEmojiGrid"></div>
      </div>
      <button class="submit-btn" onclick="saveFund()">Create Fund</button>
    </div>
  </div>

  <!-- FUND ACTION MODAL -->
  <div id="fundActionModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title" id="fundActionTitle">Add to Fund</span>
        <button class="modal-close" onclick="closeModal('fundActionModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Amount</label>
        <input type="number" id="fundActionAmount" class="form-input" placeholder="100" inputmode="decimal">
      </div>
      <div class="type-toggle">
        <button class="type-btn income active" id="fundAddBtn" onclick="setFundAction('add')">Add</button>
        <button class="type-btn expense" id="fundWithdrawBtn" onclick="setFundAction('withdraw')">Withdraw</button>
      </div>
      <button class="submit-btn" onclick="updateFund()">Confirm</button>
    </div>
  </div>

  <!-- IMPORT MODAL -->
  <div id="importModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Import Data</span>
        <button class="modal-close" onclick="closeModal('importModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Paste CSV or JSON</label>
        <textarea id="importData" class="form-input" style="min-height:150px;" placeholder="date,type,amount,description,category&#10;2024-01-15,expense,50,Groceries,groceries"></textarea>
      </div>
      <button class="submit-btn" onclick="importData()">Import</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <ul class="nav-items">
      <li><a href="../index.html" class="nav-link"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></a></li>
      <li><a href="summary.html" class="nav-link active"><span class="nav-icon">üí∞</span><span class="nav-label">Finance</span></a></li>
    </ul>
  </nav>

  <script src="../scripts/memory.js"></script>
  <script>
    // ===== DATA =====
    const categories = {
      expense: [
        { id: 'food', emoji: 'üçî', label: 'Food', color: '#EF4444' },
        { id: 'transport', emoji: 'üöó', label: 'Transport', color: '#F97316' },
        { id: 'shopping', emoji: 'üõçÔ∏è', label: 'Shopping', color: '#A855F7' },
        { id: 'utilities', emoji: 'üí°', label: 'Bills', color: '#3B82F6' },
        { id: 'groceries', emoji: 'üõí', label: 'Groceries', color: '#14B8A6' },
        { id: 'entertainment', emoji: 'üé¨', label: 'Fun', color: '#6366F1' },
        { id: 'health', emoji: 'üíä', label: 'Health', color: '#EC4899' },
        { id: 'other', emoji: 'üì¶', label: 'Other', color: '#64748B' }
      ],
      income: [
        { id: 'salary', emoji: 'üíµ', label: 'Salary', color: '#10B981' },
        { id: 'freelance', emoji: 'üíª', label: 'Freelance', color: '#22C55E' },
        { id: 'investment', emoji: 'üìà', label: 'Investment', color: '#059669' },
        { id: 'gift', emoji: 'üéÅ', label: 'Gift', color: '#34D399' },
        { id: 'refund', emoji: '‚Ü©Ô∏è', label: 'Refund', color: '#6EE7B7' },
        { id: 'other', emoji: 'üì¶', label: 'Other', color: '#64748B' }
      ]
    };
    const fundEmojis = ['üõ°Ô∏è', 'üìà', 'üéØ', 'üè†', '‚úàÔ∏è', 'üöó', 'üíç', 'üìö', 'üíº', 'üéÆ', 'üè•', 'üë∂'];
    const fundColors = ['#10B981', '#3B82F6', '#F59E0B', '#A855F7', '#EF4444', '#EC4899'];

    let state = {
      type: 'expense',
      category: null,
      tags: [],
      filter: 'all',
      search: '',
      fundAction: 'add',
      currentFundId: null,
      selectedEmoji: 'üõ°Ô∏è'
    };

    // ===== HELPERS =====
    const fmt = (n) => '$' + new Intl.NumberFormat('en-US').format(Math.round(n));
    const get = (k, d) => Memory.get('finance', k) || d;
    const set = (k, v) => Memory.set('finance', k, v);
    const getCat = (type, id) => (categories[type] || categories.expense).find(c => c.id === id) || categories.expense[7];

    // ===== INIT =====
    function init() {
      checkRecurring();
      renderAll();
      checkApiKey();
      loadChat();
      calcCompound();
      calcFreedom();
      calcROI();
      document.getElementById('chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
      document.getElementById('budgetMonth').textContent = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', b.textContent.toLowerCase().includes(tab.substring(0, 4))));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + '-tab').classList.add('active');
      document.getElementById('fab').style.display = tab === 'transactions' ? 'flex' : 'none';
    }

    // ===== TRANSACTIONS =====
    function renderTransactions() {
      let txs = get('transactions', []);
      if (state.filter !== 'all') txs = txs.filter(t => t.category === state.filter);
      if (state.search) {
        const s = state.search.toLowerCase();
        txs = txs.filter(t => t.description.toLowerCase().includes(s) || (t.tags || []).some(tag => tag.toLowerCase().includes(s)));
      }
      txs.sort((a, b) => new Date(b.date) - new Date(a.date));
      document.getElementById('transactionCount').textContent = txs.length;

      if (!txs.length) {
        document.getElementById('transactionList').innerHTML = '<div class="empty-state"><div class="empty-icon">üí∏</div><p>No transactions yet</p></div>';
        return;
      }

      const grouped = {};
      txs.forEach(t => {
        const d = formatDate(t.date);
        if (!grouped[d]) grouped[d] = [];
        grouped[d].push(t);
      });

      let html = '';
      Object.entries(grouped).forEach(([date, items]) => {
        html += `<div class="date-header">${date}</div>`;
        items.forEach(t => {
          const cat = getCat(t.type, t.category);
          const tags = (t.tags || []).map(tag => `<span class="item-tag">${tag}</span>`).join('');
          const recurring = t.recurring ? '<span class="recurring-badge">üîÑ Monthly</span>' : '';
          html += `<div class="item" onclick="deleteTransaction('${t.id}')">
            <div class="item-icon" style="background:${cat.color}15">${cat.emoji}</div>
            <div class="item-details">
              <div class="item-title">${t.description}</div>
              <div class="item-meta">${cat.label} ${tags} ${recurring}</div>
            </div>
            <div class="item-amount ${t.type}">${t.type === 'income' ? '+' : '-'}${fmt(t.amount)}</div>
          </div>`;
        });
      });
      document.getElementById('transactionList').innerHTML = html;
    }

    function formatDate(d) {
      const date = new Date(d);
      const today = new Date();
      if (date.toDateString() === today.toDateString()) return 'Today';
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);
      if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function renderFilters() {
      const txs = get('transactions', []);
      const used = new Set();
      txs.forEach(t => used.add(t.category));
      let html = `<button class="filter-pill ${state.filter === 'all' ? 'active' : ''}" onclick="setFilter('all')">All</button>`;
      used.forEach(id => {
        const cat = getCat('expense', id) || getCat('income', id);
        html += `<button class="filter-pill ${state.filter === id ? 'active' : ''}" onclick="setFilter('${id}')">${cat.emoji} ${cat.label}</button>`;
      });
      document.getElementById('categoryFilter').innerHTML = html;
    }

    function setFilter(f) { state.filter = f; renderFilters(); renderTransactions(); }
    function filterTransactions() { state.search = document.getElementById('searchInput').value; renderTransactions(); }

    function deleteTransaction(id) {
      if (!confirm('Delete this transaction?')) return;
      const txs = get('transactions', []).filter(t => t.id !== id);
      set('transactions', txs);
      renderAll();
    }

    function openTransactionModal() {
      document.getElementById('transactionModal').classList.remove('hidden');
      renderCategoryGrid();
    }

    function renderCategoryGrid() {
      const cats = categories[state.type];
      document.getElementById('categoryGrid').innerHTML = cats.map(c =>
        `<button class="category-btn ${state.category === c.id ? 'active' : ''}" onclick="state.category='${c.id}';renderCategoryGrid()">
          <span class="emoji">${c.emoji}</span><span class="label">${c.label}</span>
        </button>`
      ).join('');
    }

    function setType(t) {
      state.type = t;
      state.category = null;
      document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.type-btn.${t}`).classList.add('active');
      renderCategoryGrid();
    }

    function handleTagInput(e) {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const val = e.target.value.trim().replace(',', '');
        if (val && !state.tags.includes(val)) {
          state.tags.push(val);
          renderTags();
        }
        e.target.value = '';
      }
    }

    function renderTags() {
      const container = document.getElementById('tagsInput');
      const input = document.getElementById('tagInput');
      container.innerHTML = state.tags.map(t => `<span class="tag">${t}<span class="tag-remove" onclick="removeTag('${t}')">√ó</span></span>`).join('') +
        '<input type="text" class="tag-input" id="tagInput" placeholder="Add tag..." onkeydown="handleTagInput(event)">';
    }

    function removeTag(t) { state.tags = state.tags.filter(x => x !== t); renderTags(); }

    function addTransaction() {
      const amount = parseFloat(document.getElementById('txAmount').value);
      const desc = document.getElementById('txDesc').value.trim();
      if (!amount || !desc) return alert('Please fill all fields');

      const txs = get('transactions', []);
      txs.push({
        id: Date.now().toString(),
        type: state.type,
        amount,
        description: desc,
        category: state.category || 'other',
        tags: [...state.tags],
        recurring: document.getElementById('txRecurring').checked,
        date: new Date().toISOString()
      });
      set('transactions', txs);
      closeModal('transactionModal');
      document.getElementById('txAmount').value = '';
      document.getElementById('txDesc').value = '';
      document.getElementById('txRecurring').checked = false;
      state.tags = [];
      state.category = null;
      renderAll();
    }

    function checkRecurring() {
      const txs = get('transactions', []);
      const lastCheck = get('lastRecurringCheck', null);
      const today = new Date().toDateString();
      if (lastCheck === today) return;

      const recurring = txs.filter(t => t.recurring);
      recurring.forEach(t => {
        const txDate = new Date(t.date);
        const now = new Date();
        if (txDate.getMonth() !== now.getMonth() || txDate.getFullYear() !== now.getFullYear()) {
          txs.push({
            ...t,
            id: Date.now().toString() + Math.random(),
            date: new Date().toISOString()
          });
        }
      });
      set('transactions', txs);
      set('lastRecurringCheck', today);
    }

    // ===== BUDGETS =====
    function renderBudgets() {
      const budgets = get('budgets', []);
      const txs = get('transactions', []);
      const now = new Date();
      const monthTxs = txs.filter(t => {
        const d = new Date(t.date);
        return t.type === 'expense' && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });

      if (!budgets.length) {
        document.getElementById('budgetList').innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><p>No budgets set</p></div>';
        return;
      }

      document.getElementById('budgetList').innerHTML = budgets.map(b => {
        const cat = getCat('expense', b.category);
        const spent = monthTxs.filter(t => t.category === b.category).reduce((s, t) => s + t.amount, 0);
        const pct = Math.min(100, (spent / b.limit) * 100);
        const status = pct >= 100 ? 'danger' : pct >= 80 ? 'warning' : 'safe';
        const remaining = Math.max(0, b.limit - spent);
        return `<div class="budget-card">
          <div class="budget-header">
            <div class="budget-icon" style="background:${cat.color}15">${cat.emoji}</div>
            <div class="budget-info">
              <div class="budget-name">${cat.label}</div>
              <div class="budget-spent">${fmt(spent)} spent</div>
            </div>
            <div class="budget-amount">
              <div class="budget-remaining" style="color:${status === 'danger' ? '#EF4444' : status === 'warning' ? '#F59E0B' : '#10B981'}">${fmt(remaining)}</div>
              <div class="budget-limit">of ${fmt(b.limit)}</div>
            </div>
          </div>
          <div class="progress-bar"><div class="progress-fill ${status}" style="width:${pct}%"></div></div>
        </div>`;
      }).join('');
    }

    function openBudgetModal() {
      const existing = get('budgets', []).map(b => b.category);
      const available = categories.expense.filter(c => !existing.includes(c.id));
      document.getElementById('budgetCategory').innerHTML = available.map(c => `<option value="${c.id}">${c.emoji} ${c.label}</option>`).join('');
      document.getElementById('budgetModal').classList.remove('hidden');
    }

    function addBudget() {
      const category = document.getElementById('budgetCategory').value;
      const limit = parseFloat(document.getElementById('budgetLimit').value);
      if (!limit) return alert('Please enter a limit');
      const budgets = get('budgets', []);
      budgets.push({ category, limit });
      set('budgets', budgets);
      closeModal('budgetModal');
      renderBudgets();
    }

    // ===== FUNDS =====
    function renderFunds() {
      const funds = get('funds', []);
      const total = funds.reduce((s, f) => s + (f.current || 0), 0);
      document.getElementById('fundsTotal').textContent = fmt(total) + ' saved';

      if (!funds.length) {
        document.getElementById('fundsList').innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div><p>No savings goals yet</p></div>';
        return;
      }

      document.getElementById('fundsList').innerHTML = funds.map(f => {
        const pct = f.target > 0 ? Math.min(100, (f.current / f.target) * 100) : 0;
        return `<div class="fund-card">
          <div class="fund-header">
            <div class="fund-icon" style="background:${f.color}15">${f.emoji}</div>
            <div class="fund-info">
              <div class="fund-name">${f.name}</div>
              <div class="fund-meta">${pct.toFixed(0)}% complete</div>
            </div>
          </div>
          <div class="fund-progress">
            <div class="progress-bar"><div class="progress-fill safe" style="width:${pct}%;background:${f.color}"></div></div>
            <div class="progress-stats">
              <span class="progress-current">${fmt(f.current || 0)}</span>
              <span>of ${fmt(f.target)}</span>
            </div>
          </div>
          <div class="fund-actions">
            <button class="fund-btn add" onclick="openFundAction('${f.id}','add')">+ Add</button>
            <button class="fund-btn withdraw" onclick="openFundAction('${f.id}','withdraw')">- Withdraw</button>
          </div>
        </div>`;
      }).join('');
    }

    function openFundModal() {
      document.getElementById('fundEmojiGrid').innerHTML = fundEmojis.map(e =>
        `<button class="category-btn ${state.selectedEmoji === e ? 'active' : ''}" onclick="state.selectedEmoji='${e}';openFundModal()">
          <span class="emoji">${e}</span>
        </button>`
      ).join('');
      document.getElementById('fundModal').classList.remove('hidden');
    }

    function saveFund() {
      const name = document.getElementById('fundName').value.trim();
      const target = parseFloat(document.getElementById('fundTarget').value);
      if (!name || !target) return alert('Please fill all fields');
      const funds = get('funds', []);
      funds.push({ id: Date.now().toString(), name, target, current: 0, emoji: state.selectedEmoji, color: fundColors[funds.length % fundColors.length] });
      set('funds', funds);
      closeModal('fundModal');
      document.getElementById('fundName').value = '';
      document.getElementById('fundTarget').value = '';
      renderFunds();
    }

    function openFundAction(id, action) {
      state.currentFundId = id;
      state.fundAction = action;
      const fund = get('funds', []).find(f => f.id === id);
      document.getElementById('fundActionTitle').textContent = action === 'add' ? `Add to ${fund.name}` : `Withdraw from ${fund.name}`;
      setFundAction(action);
      document.getElementById('fundActionModal').classList.remove('hidden');
    }

    function setFundAction(a) {
      state.fundAction = a;
      document.getElementById('fundAddBtn').classList.toggle('active', a === 'add');
      document.getElementById('fundWithdrawBtn').classList.toggle('active', a === 'withdraw');
    }

    function updateFund() {
      const amount = parseFloat(document.getElementById('fundActionAmount').value);
      if (!amount) return;
      const funds = get('funds', []);
      const fund = funds.find(f => f.id === state.currentFundId);
      if (fund) {
        fund.current = state.fundAction === 'add' ? (fund.current || 0) + amount : Math.max(0, (fund.current || 0) - amount);
        set('funds', funds);
      }
      closeModal('fundActionModal');
      document.getElementById('fundActionAmount').value = '';
      renderAll();
    }

    // ===== INSIGHTS =====
    function renderInsights() {
      const txs = get('transactions', []);
      const funds = get('funds', []);

      // Net worth
      let income = 0, expense = 0;
      txs.forEach(t => t.type === 'income' ? income += t.amount : expense += t.amount);
      const fundTotal = funds.reduce((s, f) => s + (f.current || 0), 0);
      const netWorth = income - expense + fundTotal;
      document.getElementById('netWorth').textContent = fmt(netWorth);
      document.getElementById('totalAssets').textContent = fmt(income + fundTotal);
      document.getElementById('totalLiabilities').textContent = fmt(expense);

      // Chart
      renderChart();

      // AI Insights
      generateInsights();
    }

    function renderChart() {
      const txs = get('transactions', []);
      const months = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        months.push({ month: d.toLocaleDateString('en-US', { month: 'short' }), income: 0, expense: 0 });
      }

      txs.forEach(t => {
        const d = new Date(t.date);
        const idx = months.findIndex(m => m.month === d.toLocaleDateString('en-US', { month: 'short' }));
        if (idx !== -1) {
          t.type === 'income' ? months[idx].income += t.amount : months[idx].expense += t.amount;
        }
      });

      const max = Math.max(...months.flatMap(m => [m.income, m.expense]), 1);
      document.getElementById('monthlyChart').innerHTML = months.map(m => `
        <div style="flex:1;display:flex;gap:3px;align-items:flex-end;position:relative;">
          <div class="chart-bar" style="height:${(m.income / max) * 100}%"></div>
          <div class="chart-bar expense" style="height:${(m.expense / max) * 100}%"></div>
          <div class="chart-label">${m.month}</div>
        </div>
      `).join('');
    }

    function generateInsights() {
      const txs = get('transactions', []);
      const budgets = get('budgets', []);
      const insights = [];

      // Spending vs Income
      let income = 0, expense = 0;
      txs.forEach(t => t.type === 'income' ? income += t.amount : expense += t.amount);
      const savings = income - expense;
      const savingsRate = income > 0 ? (savings / income) * 100 : 0;

      if (savingsRate >= 20) {
        insights.push({ type: 'success', icon: 'üéâ', title: 'Great savings rate!', text: `You're saving ${savingsRate.toFixed(0)}% of your income. Keep it up!` });
      } else if (savingsRate >= 0) {
        insights.push({ type: 'warning', icon: 'üí°', title: 'Room for improvement', text: `You're saving ${savingsRate.toFixed(0)}%. Aim for 20%+ to build wealth faster.` });
      } else {
        insights.push({ type: 'danger', icon: '‚ö†Ô∏è', title: 'Spending exceeds income', text: `You're spending more than you earn. Review your expenses.` });
      }

      // Budget alerts
      const now = new Date();
      const monthTxs = txs.filter(t => {
        const d = new Date(t.date);
        return t.type === 'expense' && d.getMonth() === now.getMonth();
      });

      budgets.forEach(b => {
        const spent = monthTxs.filter(t => t.category === b.category).reduce((s, t) => s + t.amount, 0);
        const pct = (spent / b.limit) * 100;
        if (pct >= 100) {
          const cat = getCat('expense', b.category);
          insights.push({ type: 'danger', icon: 'üö®', title: `${cat.label} over budget!`, text: `You've spent ${fmt(spent)} of your ${fmt(b.limit)} budget.` });
        } else if (pct >= 80) {
          const cat = getCat('expense', b.category);
          insights.push({ type: 'warning', icon: '‚ö°', title: `${cat.label} almost maxed`, text: `${pct.toFixed(0)}% of budget used. ${fmt(b.limit - spent)} remaining.` });
        }
      });

      // Top spending category
      const byCategory = {};
      monthTxs.forEach(t => { byCategory[t.category] = (byCategory[t.category] || 0) + t.amount; });
      const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
      if (sorted.length) {
        const [topCat, topAmount] = sorted[0];
        const cat = getCat('expense', topCat);
        insights.push({ type: 'info', icon: 'üìä', title: `Top spending: ${cat.label}`, text: `You've spent ${fmt(topAmount)} on ${cat.label} this month.` });
      }

      document.getElementById('insightsList').innerHTML = insights.map(i => `
        <div class="insight-card ${i.type === 'danger' ? 'warning' : i.type === 'info' ? 'info' : ''}">
          <div class="insight-icon">${i.icon}</div>
          <div class="insight-title">${i.title}</div>
          <div class="insight-text">${i.text}</div>
        </div>
      `).join('') || '<div class="empty-state"><p>Add more transactions to see insights</p></div>';
    }

    // ===== CALCULATORS =====
    function calcCompound() {
      const p = parseFloat(document.getElementById('ciPrincipal').value) || 0;
      const m = parseFloat(document.getElementById('ciMonthly').value) || 0;
      const r = (parseFloat(document.getElementById('ciRate').value) || 0) / 100 / 12;
      const n = (parseFloat(document.getElementById('ciYears').value) || 0) * 12;
      const fv = p * Math.pow(1 + r, n) + m * ((Math.pow(1 + r, n) - 1) / r);
      document.getElementById('ciResult').textContent = fmt(fv);
    }

    function calcFreedom() {
      const expenses = parseFloat(document.getElementById('ffExpenses').value) || 1;
      const savings = parseFloat(document.getElementById('ffSavings').value) || 0;
      const monthly = parseFloat(document.getElementById('ffMonthlySave').value) || 0;
      const rate = (parseFloat(document.getElementById('ffReturn').value) || 0) / 100 / 12;
      const target = expenses * 12 * 25; // 4% rule

      let current = savings;
      let months = 0;
      while (current < target && months < 1200) {
        current = current * (1 + rate) + monthly;
        months++;
      }
      document.getElementById('ffResult').textContent = months < 1200 ? `${(months / 12).toFixed(1)} years` : '100+ years';
    }

    function calcROI() {
      const initial = parseFloat(document.getElementById('roiInitial').value) || 1;
      const final = parseFloat(document.getElementById('roiFinal').value) || 0;
      const roi = ((final - initial) / initial) * 100;
      document.getElementById('roiResult').textContent = roi.toFixed(1) + '%';
    }

    // ===== AI =====
    function checkApiKey() {
      const key = Memory.get('settings', 'anthropic_api_key');
      document.getElementById('api-notice').style.display = key ? 'none' : 'block';
      document.getElementById('chat-container').style.display = key ? 'flex' : 'none';
    }

    function saveApiKey() {
      const key = document.getElementById('api-key-input').value.trim();
      if (!key) return;
      Memory.set('settings', 'anthropic_api_key', key);
      checkApiKey();
      loadChat();
    }

    function loadChat() {
      const history = get('chatHistory', []);
      const container = document.getElementById('chat-messages');
      if (!history.length) {
        container.innerHTML = `<div class="ai-message">üëã Hi! I'm your AI Financial Advisor. Ask me anything about your finances, budgeting, or saving strategies!</div>`;
        return;
      }
      container.innerHTML = history.map(m => `<div class="${m.role === 'user' ? 'user-message' : 'ai-message'} message">${m.content}</div>`).join('');
      container.scrollTop = container.scrollHeight;
    }

    function askAI(q) { document.getElementById('chat-input').value = q; sendMessage(); }

    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (!msg) return;

      const apiKey = Memory.get('settings', 'anthropic_api_key');
      if (!apiKey) return checkApiKey();

      const history = get('chatHistory', []);
      history.push({ role: 'user', content: msg });
      set('chatHistory', history);
      input.value = '';
      loadChat();

      const container = document.getElementById('chat-messages');
      container.innerHTML += `<div class="ai-message">...</div>`;
      container.scrollTop = container.scrollHeight;

      const txs = get('transactions', []);
      const funds = get('funds', []);
      const budgets = get('budgets', []);
      let income = 0, expense = 0;
      txs.forEach(t => t.type === 'income' ? income += t.amount : expense += t.amount);

      const system = `You are a helpful AI Financial Advisor. Be concise and practical.

USER DATA:
- Income: ${fmt(income)}
- Expenses: ${fmt(expense)}
- Balance: ${fmt(income - expense)}
- Savings Rate: ${income > 0 ? ((income - expense) / income * 100).toFixed(1) : 0}%
- Funds: ${funds.length ? funds.map(f => `${f.name}: ${fmt(f.current)}/${fmt(f.target)}`).join(', ') : 'None'}
- Budgets: ${budgets.length ? budgets.map(b => `${getCat('expense', b.category).label}: ${fmt(b.limit)}/mo`).join(', ') : 'None'}
- Recent transactions: ${txs.slice(0, 10).map(t => `${t.description}: ${t.type === 'expense' ? '-' : '+'}${fmt(t.amount)}`).join(', ')}

If user wants to create a fund, include: [CREATE_FUND:name|target|emoji|color]
Emojis: üõ°Ô∏èüìàüéØüè†‚úàÔ∏èüöóüíçüìöüíºüéÆüè•üë∂
Colors: #10B981,#3B82F6,#F59E0B,#A855F7,#EF4444,#EC4899`;

      try {
        const res = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
          body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 800, system, messages: history.map(m => ({ role: m.role, content: m.content })) })
        });
        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        let reply = data.content[0].text;

        const match = reply.match(/\[CREATE_FUND:(.+?)\|(\d+)\|(.+?)\|(.+?)\]/);
        if (match) {
          const [, name, target, emoji, color] = match;
          reply = reply.replace(/\[CREATE_FUND:.+?\]/, '') + `<button class="quick-prompt" style="margin-top:8px" onclick="createFundFromAI('${name}',${target},'${emoji}','${color}')">‚úì Create ${name}</button>`;
        }

        history.push({ role: 'assistant', content: reply });
        set('chatHistory', history);
      } catch (e) {
        history.push({ role: 'assistant', content: 'Sorry, something went wrong. Please try again.' });
        set('chatHistory', history);
      }
      loadChat();
    }

    function createFundFromAI(name, target, emoji, color) {
      const funds = get('funds', []);
      funds.push({ id: Date.now().toString(), name, target, current: 0, emoji, color });
      set('funds', funds);
      renderFunds();
      switchTab('funds');
    }

    // ===== IMPORT/EXPORT =====
    function openImportModal() { document.getElementById('importModal').classList.remove('hidden'); }

    function importData() {
      const data = document.getElementById('importData').value.trim();
      if (!data) return;

      try {
        if (data.startsWith('[') || data.startsWith('{')) {
          const json = JSON.parse(data);
          if (Array.isArray(json)) {
            const txs = get('transactions', []);
            json.forEach(t => txs.push({ ...t, id: Date.now().toString() + Math.random() }));
            set('transactions', txs);
          }
        } else {
          const lines = data.split('\n').filter(l => l.trim());
          const txs = get('transactions', []);
          lines.slice(1).forEach(line => {
            const [date, type, amount, description, category] = line.split(',').map(s => s.trim());
            if (date && amount) {
              txs.push({ id: Date.now().toString() + Math.random(), date: new Date(date).toISOString(), type: type || 'expense', amount: parseFloat(amount), description: description || 'Imported', category: category || 'other', tags: [] });
            }
          });
          set('transactions', txs);
        }
        closeModal('importModal');
        document.getElementById('importData').value = '';
        renderAll();
        alert('Import successful!');
      } catch (e) {
        alert('Invalid format. Use CSV or JSON.');
      }
    }

    function exportData() {
      const txs = get('transactions', []);
      const csv = 'date,type,amount,description,category,tags\n' + txs.map(t =>
        `${new Date(t.date).toISOString().split('T')[0]},${t.type},${t.amount},${t.description},${t.category},${(t.tags || []).join(';')}`
      ).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'finance-export.csv';
      a.click();
    }

    // ===== UTILS =====
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    function renderTotals() {
      const txs = get('transactions', []);
      let income = 0, expense = 0;
      txs.forEach(t => t.type === 'income' ? income += t.amount : expense += t.amount);
      document.getElementById('totalIncome').textContent = fmt(income);
      document.getElementById('totalExpense').textContent = fmt(expense);
      document.getElementById('totalBalance').textContent = fmt(income - expense);
    }

    function renderAll() {
      renderTotals();
      renderFilters();
      renderTransactions();
      renderBudgets();
      renderFunds();
      renderInsights();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
